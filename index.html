<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Anatomy Quiz Player</title>
<style>
  body {
    background-color: #121212;
    color: #eee;
    font-family: system-ui, sans-serif;
    max-width: 900px;
    margin: 20px auto;
  }
  h1 {
    text-align: center;
    margin-bottom: 10px;
  }
  #quiz-gallery { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
    gap: 12px; 
  }
  .quiz-card { 
    border: 1px solid #333; 
    border-radius: 12px; 
    overflow: hidden; 
    background: #1e1e1e; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.5); 
    cursor: pointer; 
    transition: transform .12s ease, box-shadow .12s ease; 
  }
  .quiz-card:hover { transform: translateY(-2px); box-shadow: 0 6px 14px rgba(0,0,0,0.6); }
  .quiz-card.active { outline: 2px solid #2c7be5; }
  .quiz-thumb { width: 100%; height: 110px; object-fit: cover; display:block; background:#222; }
  .quiz-meta { padding: 8px 10px; }
  .quiz-title { font-size: 0.95rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .quiz-count { font-size: 0.8rem; color: #aaa; }
  #image-container { position: relative; margin-top: 20px; }
  #uploaded-image { max-width: 100%; display: block; margin: 0 auto; }
  .hotspot { position: absolute; width: 20px; height: 20px; border-radius: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.3); border: 2px solid #aaa; cursor: pointer; }
  .hotspot:hover { background: rgba(255,255,255,0.6); }
  .hotspot-correct { background: rgba(76,175,80,0.5) !important; border: 2px solid #4caf50 !important; }
  #question-text, #feedback { text-align: center; margin: 10px 0; font-size: 1.2rem; }
  #results-panel { margin-top: 20px; padding: 20px; background: #1e1e1e; border: 1px solid #333; border-radius: 12px; text-align: center; }
  #results-panel .accuracy { font-size: 2rem; margin: 10px 0; }
  #results-panel .progress { width: 100%; height: 20px; background: #333; border-radius: 10px; overflow: hidden; margin: 10px 0; }
  #results-panel .progress-bar { height: 100%; background: #4caf50; text-align: center; color: #fff; font-size: 0.9rem; line-height: 20px; }
  #results-panel button { margin: 8px; padding: 8px 14px; }
</style>
</head>
<body>

<h1>Anatomy Quiz Player</h1>

<div id="quiz-gallery"></div>

<div id="mode-indicator">Mode: <span id="mode-label">Play Mode</span></div>

<div id="image-container">
  <img id="uploaded-image" alt="Quiz anatomy" />
</div>

<div id="quiz-ui">
  <div id="question-text"></div>
  <div id="feedback"></div>
</div>

<script>
(() => {
  const uploadedImage = document.getElementById('uploaded-image');
  const imageContainer = document.getElementById('image-container');
  const modeLabel = document.getElementById('mode-label');
  const quizGallery = document.getElementById('quiz-gallery');
  const questionTextDiv = document.getElementById('question-text');
  const feedbackDiv = document.getElementById('feedback');

  let quizzes = [];
  let currentQuizIndex = -1;
  let inPlayMode = true;
  let currentQuestionIndex = 0;
  let playerCorrect = 0;
  let playerTotal = 0;

  async function loadAllQuizzes() {
    try {
      const res = await fetch("all_quizzes_full.json", { cache: "no-store" });
      if (!res.ok) throw new Error("Failed to load bundled quiz file");
      const data = await res.json();
      const bundle = data.quizzes || {};
      quizzes = Object.keys(bundle).map(k => ({ name: k.replace(/_/g, " "), data: bundle[k] }));
      if (quizzes.length) {
        currentQuizIndex = 0;
        loadQuiz(currentQuizIndex);
        renderQuizGallery();
      }
    } catch (e) {
      console.error("Error loading all_quizzes_full.json:", e);
    }
  }

  function renderQuizGallery() {
    quizGallery.innerHTML = "";
    quizzes.forEach((q, idx) => {
      const card = document.createElement("div");
      card.className = "quiz-card" + (idx === currentQuizIndex ? " active" : "");
      const img = document.createElement("img");
      img.className = "quiz-thumb";
      img.src = q.data.imageSrc || "";
      img.alt = q.name;
      const meta = document.createElement("div");
      meta.className = "quiz-meta";
      meta.innerHTML = `<div class="quiz-title">${q.name}</div>
                        <div class="quiz-count">${q.data.hotspots?.length || 0} hotspots</div>`;
      card.appendChild(img);
      card.appendChild(meta);
      card.addEventListener("click", () => {
        currentQuizIndex = idx;
        loadQuiz(currentQuizIndex);
        highlightActiveCard();
        imageContainer.scrollIntoView({ behavior: "smooth", block: "start" });
      });
      quizGallery.appendChild(card);
    });
  }
  function highlightActiveCard() {
    quizGallery.querySelectorAll(".quiz-card").forEach((c, i) => {
      c.classList.toggle("active", i === currentQuizIndex);
    });
  }

  function loadQuiz(index) {
    if (index < 0 || index >= quizzes.length) return;
    const quiz = quizzes[index];
    uploadedImage.src = quiz.data.imageSrc;
    modeLabel.textContent = "Play Mode";
    enterPlayMode();
  }

  function enterPlayMode() {
    inPlayMode = true;
    currentQuestionIndex = 0;
    playerCorrect = 0;
    playerTotal = 0;
    showCurrentQuestion();
    renderHotspots();
  }

  function showCurrentQuestion() {
    const hotspots = quizzes[currentQuizIndex].data.hotspots;
    if (currentQuestionIndex >= hotspots.length) {
      showResults();
      return;
    }
    questionTextDiv.textContent = `Identify: ${hotspots[currentQuestionIndex].question}`;
    feedbackDiv.textContent = "Click the correct hotspot.";
    clearHotspotStates();
  }

  function renderHotspots() {
    imageContainer.querySelectorAll('.hotspot').forEach(dot => dot.remove());
    const hotspots = quizzes[currentQuizIndex].data.hotspots;
    hotspots.forEach((h, idx) => {
      const dot = document.createElement('div');
      dot.className = 'hotspot';
      dot.style.left = h.xPercent + '%';
      dot.style.top = h.yPercent + '%';
      dot.dataset.index = idx;
      dot.addEventListener('click', () => handlePlayClick(idx));
      imageContainer.appendChild(dot);
    });
  }

  function clearHotspotStates() {
    imageContainer.querySelectorAll('.hotspot').forEach(dot => {
      dot.classList.remove('hotspot-correct');
    });
  }

  function handlePlayClick(clickedIndex) {
    const hotspots = quizzes[currentQuizIndex].data.hotspots;
    if (currentQuestionIndex >= hotspots.length) return;
    playerTotal++;
    if (clickedIndex === currentQuestionIndex) {
      playerCorrect++;
      feedbackDiv.textContent = "✅ Correct!";
      markHotspot(clickedIndex, true);
      currentQuestionIndex++;
      if (currentQuestionIndex < hotspots.length) {
        setTimeout(() => showCurrentQuestion(), 1000);
      } else {
        setTimeout(() => showResults(), 1000);
      }
    } else {
      feedbackDiv.textContent = "❌ Incorrect, try again.";
    }
  }

  function markHotspot(idx, correct) {
    const dot = imageContainer.querySelector(`.hotspot[data-index="${idx}"]`);
    if (dot && correct) dot.classList.add('hotspot-correct');
  }

  function showResults() {
    questionTextDiv.textContent = "";
    feedbackDiv.textContent = "";
    const pct = Math.round((playerCorrect / playerTotal) * 100);
    const existing = document.getElementById('results-panel');
    if (existing) existing.remove();
    const panel = document.createElement('div');
    panel.id = 'results-panel';
    panel.innerHTML = `<h3>Results</h3>
      <div class="accuracy">${pct}%</div>
      <div class="progress"><div class="progress-bar" style="width:${pct}%">${playerCorrect}/${playerTotal}</div></div>
      <button id="replay-btn">Replay Quiz</button>
      <button id="choose-btn">Choose Another</button>`;
    document.body.appendChild(panel);
    document.getElementById('replay-btn').addEventListener('click', ()=>{ loadQuiz(currentQuizIndex); window.scrollTo({ top: 0, behavior: 'smooth' }); });
    document.getElementById('choose-btn').addEventListener('click', ()=>{ quizGallery.scrollIntoView({ behavior: 'smooth' }); });
    panel.scrollIntoView({ behavior: 'smooth' });
  }

  loadAllQuizzes();
})();
</script>

</body>
</html>
